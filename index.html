<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Overlay - Lofi Controller</title>
  <script src="https://unpkg.com/tone"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <div id="controls">
        <div class="control-row">
          <label for="select-song">Song:</label>
          <select id="select-song" class="select-control">
            <option value="">-- Select Song --</option>
          </select>
        </div>
        <div class="control-row">
          <label for="select-visual">Visual:</label>
          <select id="select-visual" class="select-control">
            <option value="">-- Select Visual --</option>
          </select>
        </div>
        <div class="control-buttons">
          <button id="btn-play" class="btn-primary">Play</button>
          <button id="btn-pause" class="btn-outline">Pause</button>
          <button id="btn-stop" class="btn-outline">Stop</button>
        </div>
      </div>

      <div id="status">
        <div class="status-item">
          <span class="label">Deck:</span>
          <span class="value" id="status-deck">A</span>
        </div>
        <div class="status-item">
          <span class="label">Song:</span>
          <span class="value" id="status-song">-</span>
        </div>
        <div class="status-item">
          <span class="label">Section:</span>
          <span class="value" id="status-section">-</span>
        </div>
        <div class="status-item">
          <span class="label">Playing:</span>
          <span class="value" id="status-playing">No</span>
        </div>
      </div>
    </div>

    <div id="visual-container"></div>
  </div>

  <script type="module">
    import { DJController } from './src/controller.js';
    import { bus } from './src/event-bus.js';

    // Initialize controller
    const controller = new DJController();
    const visualContainer = document.getElementById('visual-container');

    // Status elements
    const statusDeck = document.getElementById('status-deck');
    const statusSong = document.getElementById('status-song');
    const statusSection = document.getElementById('status-section');
    const statusPlaying = document.getElementById('status-playing');

    // Dropdown elements
    const selectSong = document.getElementById('select-song');
    const selectVisual = document.getElementById('select-visual');

    // Registry data
    let registry = { songs: [], visuals: [] };

    // Load config
    let config = {
      defaults: { song: null, visual: null, autoPlay: false },
      display: { showControls: true, showStatus: true }
    };

    try {
      const response = await fetch('./config.json');
      if (response.ok) {
        config = await response.json();
        console.log('[DJ] Config loaded:', config);
      }
    } catch (e) {
      console.log('[DJ] No config.json found, using defaults');
    }

    // Load registry
    try {
      const response = await fetch('./registry.json');
      if (response.ok) {
        registry = await response.json();
        console.log('[DJ] Registry loaded:', registry);
      }
    } catch (e) {
      console.log('[DJ] No registry.json found');
    }

    // Populate dropdowns from registry
    function populateDropdowns() {
      // Songs - only show "ready" status
      registry.songs
        .filter(s => s.status === 'ready')
        .forEach(song => {
          const option = document.createElement('option');
          option.value = song.path + '/index.js';
          option.textContent = song.name;
          option.title = song.description || '';
          selectSong.appendChild(option);
        });

      // Visuals - only show "ready" status
      registry.visuals
        .filter(v => v.status === 'ready')
        .forEach(visual => {
          const option = document.createElement('option');
          option.value = visual.path + '/index.js';
          option.textContent = visual.name;
          option.title = visual.description || '';
          selectVisual.appendChild(option);
        });
    }

    // Apply display settings
    if (!config.display?.showControls) {
      document.getElementById('controls').style.display = 'none';
    }
    if (!config.display?.showStatus) {
      document.getElementById('status').style.display = 'none';
    }

    // Initialize on page load
    async function init() {
      await controller.init(visualContainer);
      console.log('[DJ] Controller initialized');

      // Populate dropdowns
      populateDropdowns();

      // Auto-load defaults from config
      if (config.defaults?.song) {
        try {
          await controller.loadSong(config.defaults.song, 'A');
          statusSong.textContent = config.defaults.song.split('/').filter(Boolean)[0];
          selectSong.value = config.defaults.song;
          console.log('[DJ] Auto-loaded song:', config.defaults.song);
        } catch (e) {
          console.error('[DJ] Failed to auto-load song:', e);
        }
      }

      if (config.defaults?.visual) {
        try {
          await controller.loadVisual(config.defaults.visual, 0);
          selectVisual.value = config.defaults.visual;
          console.log('[DJ] Auto-loaded visual:', config.defaults.visual);
        } catch (e) {
          console.error('[DJ] Failed to auto-load visual:', e);
        }
      }

      // Auto-play if configured
      if (config.defaults?.autoPlay && config.defaults?.song) {
        await controller.play();
        console.log('[DJ] Auto-play started');
      }
    }

    // Event listeners for status updates
    bus.on('songLoaded', ({ deck, song }) => {
      if (deck === controller.activeDeck) {
        statusSong.textContent = song;
      }
    });

    bus.on('sectionChange', ({ section }) => {
      statusSection.textContent = section;
    });

    bus.on('play', () => {
      statusPlaying.textContent = 'Yes';
    });

    bus.on('pause', () => {
      statusPlaying.textContent = 'Paused';
    });

    bus.on('stop', () => {
      statusPlaying.textContent = 'No';
      statusSection.textContent = '-';
    });

    // Dropdown handlers
    selectSong.onchange = async () => {
      const path = selectSong.value;
      if (!path) return;
      try {
        await controller.loadSong(path, 'A');
        const songName = path.split('/').filter(Boolean)[0];
        statusSong.textContent = songName;
        console.log('[DJ] Loaded song:', songName);
      } catch (e) {
        console.error('Failed to load song:', e);
        alert('Failed to load song: ' + e.message);
      }
    };

    selectVisual.onchange = async () => {
      const path = selectVisual.value;
      if (!path) return;
      try {
        await controller.loadVisual(path, 0);
        const visualName = path.split('/').filter(Boolean)[0];
        console.log('[DJ] Loaded visual:', visualName);
      } catch (e) {
        console.error('Failed to load visual:', e);
        alert('Failed to load visual: ' + e.message);
      }
    };

    // Button handlers
    document.getElementById('btn-play').onclick = async () => {
      if (!controller.deckA && !controller.deckB) {
        alert('Load a song first!');
        return;
      }
      await controller.play();
    };

    document.getElementById('btn-pause').onclick = () => {
      controller.pause();
    };

    document.getElementById('btn-stop').onclick = () => {
      controller.stop();
    };

    // Initialize
    init();
  </script>
</body>
</html>
